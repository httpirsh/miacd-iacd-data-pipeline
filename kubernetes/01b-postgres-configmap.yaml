apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
data:
  init.sql: |
    -- Database: co2_emissions (created automatically by POSTGRES_DB env var)
    
    -- Table to store clustering results
    CREATE TABLE IF NOT EXISTS co2_clusters (
        id SERIAL PRIMARY KEY,
        batch_id INTEGER,
        country VARCHAR(100),
        iso_code VARCHAR(10),
        avg_co2 DECIMAL(15,4),
        avg_co2_per_capita DECIMAL(15,4),
        avg_gdp DECIMAL(20,4),
        avg_population DECIMAL(20,4),
        cluster INTEGER,
        processing_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Table to store cluster statistics
    CREATE TABLE IF NOT EXISTS cluster_stats (
        id SERIAL PRIMARY KEY,
        batch_id INTEGER,
        cluster INTEGER,
        num_countries INTEGER,
        avg_co2_cluster DECIMAL(15,4),
        avg_co2_per_capita_cluster DECIMAL(15,4),
        avg_gdp_cluster DECIMAL(20,4),
        processing_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Table for temporal clustering (by year)
    CREATE TABLE IF NOT EXISTS co2_clustering_temporal (
        id SERIAL PRIMARY KEY,
        batch_id INTEGER,
        country VARCHAR(100),
        iso_code VARCHAR(10),
        year INTEGER,
        co2 DECIMAL(15,4),
        co2_per_capita DECIMAL(15,4),
        gdp DECIMAL(20,4),
        population DECIMAL(20,4),
        cluster INTEGER,
        processing_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Indexes for better query performance
    CREATE INDEX IF NOT EXISTS idx_co2_clusters_country ON co2_clusters(country);
    CREATE INDEX IF NOT EXISTS idx_co2_clusters_cluster ON co2_clusters(cluster);
    CREATE INDEX IF NOT EXISTS idx_co2_clusters_batch ON co2_clusters(batch_id);
    CREATE INDEX IF NOT EXISTS idx_temporal_year ON co2_clustering_temporal(year);
    CREATE INDEX IF NOT EXISTS idx_temporal_country ON co2_clustering_temporal(country);
    
    -- View for cluster analysis
    CREATE OR REPLACE VIEW cluster_analysis AS
    SELECT 
        cluster,
        COUNT(*) as country_count,
        ROUND(AVG(avg_co2), 2) as avg_co2,
        ROUND(AVG(avg_co2_per_capita), 2) as avg_co2_per_capita,
        ROUND(AVG(avg_gdp), 2) as avg_gdp,
        ROUND(AVG(avg_population), 2) as avg_population
    FROM co2_clusters
    GROUP BY cluster
    ORDER BY cluster;
    
    -- View for top emitters per cluster
    CREATE OR REPLACE VIEW top_emitters_by_cluster AS
    SELECT 
        cluster,
        country,
        ROUND(avg_co2, 2) as avg_co2,
        ROUND(avg_co2_per_capita, 2) as co2_per_capita,
        ROUND(avg_gdp, 2) as gdp
    FROM (
        SELECT *,
               ROW_NUMBER() OVER (PARTITION BY cluster ORDER BY avg_co2 DESC) as rn
        FROM co2_clusters
    ) ranked
    WHERE rn <= 10
    ORDER BY cluster, avg_co2 DESC;
